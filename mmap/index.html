<!DOCTYPE html>

<html>

        <head>
                <title>Dylan's Marauder's Map</title>
                <meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />
                <meta charset="utf-8" />
                <link rel="stylesheet" href="mmapStyle.css" />
                <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
                <script>
                        /* Map Data*/
                        var myLat = 42.4069;
                        var myLng = -71.1198;
                        var myLoc = new google.maps.LatLng(myLat, myLng);
                        var map;
                        var mapOptions = {
                                zoom: 13,
                                center: myLoc,
                                mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                        var marker;
                        var myMarkerOptions= {
                                map: map,
                                title: "KyleBroflovski",
                                position: myLoc
                        };
                        var infoWindow = new google.maps.InfoWindow();

                        /* Specifically XMLHttpRequest Data */
                        var request = new XMLHttpRequest();
                        var params;
                        var url = "http://chickenofthesea.herokuapp.com/sendLocation";
                        var userData;

                        request.open("POST", url, true);
                        request.setRequestHeader('Content-type','application/x-www-form-urlencoded');
                        
                        request.onreadystatechange = function() {
                                if(request.readyState == 4 && request.status == 200) {
                                        userData = JSON.parse(request.responseText);
                                        parseCharacters();
                                        parseStudents();
                                }
                        };

                        /* Summary: Starts function calls to build entire map */
                        function init() {
                                map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
                                getMyLocation();
                        }

                        /* Summary: Using google maps API, obtains my lat and lng data */
                        function getMyLocation() {
                                if (navigator.geolocation) {
                                        navigator.geolocation.getCurrentPosition(function(position) {
                                                myLat = position.coords.latitude;
                                                myLng = position.coords.longitude;
                                                /* Make a marker for my location */
                                                makeMyMarker();
                                                makePost();
                                                });
                                } else {
                                        alert("Geolocation is not supported on your web browser -- cannot display map");
                                }
                        }

                        /* Summary: Makes a marker for my character */
                        function makeMyMarker() {
                                /* Update my location */
                                myLoc = new google.maps.LatLng(myLat, myLng);
                                map.panTo(myLoc);
                                myMarkerOptions.position = myLoc;

                                myMarker = new google.maps.Marker(myMarkerOptions);
                                myMarker.setMap(map);

                                google.maps.event.addListener(myMarker, 'click', function() {
                                        infoWindow.setContent(myMarker.title);
                                        infoWindow.open(map, myMarker);
                                });
                        }

                        /* Summary: Makes a post to the heroku server with user information */ 
                        function makePost() { 
                                /* Build Params */
                                params = "login=" + myMarkerOptions.title + "&lat=" + myLat + "&lng=" + myLng;
                                
                                request.send(params);
                        }

                        /* Summary: Parses the data for each character */ 
                        function parseCharacters() {
                                var characters = userData['characters'];
                                for (i = 0; i < characters.length; i++) {
                                        createMarker(characters[i]);
                                }
                        }
                        /* Summary: Parses the data for each student */ 
                        function parseStudents() {
                                var students = userData['students'];
                                
                        }

                        function marker() { 
                                console.log("TEST");
                        }

                        function createMarker(person) {
                                if (person['login'] == undefined) {
                                        var personName = person['name'];
                                        console.log("IS a Characer: " + personName);                                    //// NEED TO DELETE
                                } else if (person['name'] == undefined) {
                                        var personName = person['login'];
                                        console.log("Is a student: " + personName);                                     //// NEED TO DELETE
                                } 
                                var personLat = person['loc']['latitude'];
                                var personLng = person['loc']['longitude'];
                                var personLoc = new google.maps.LatLng(personLat, personLng);

                                var personMarker = new google.maps.Marker({
                                        map: map,
                                        title: personName,
                                        position: personLoc
                                });

                                google.maps.event.addListener(personMarker, 'click', function () { 
                                        infoWindow.close();
                                        infoWindow.setContent(personMarker.title);
                                        infoWindow.open();
                                });
                        }
                </script>
        </head>


        <body onload=init()>
                <div id="map_canvas"></div>
        </body>

</html>